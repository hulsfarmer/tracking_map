<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Footprints Stats</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --vh: 100dvh; }
        body { height: var(--vh); margin: 0; overflow: hidden; background: #fff; }
        .app-layout { display: flex; flex-direction: column; height: var(--vh); max-width: 500px; margin: 0 auto; }
        .page { display: none; flex: 1; height: calc(var(--vh) - 85px); overflow-y: auto; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: white; border-top: 1px solid #f1f1f1; display: flex; z-index: 9999; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 11px; font-weight: 800; }
        .nav-item.active { color: #2563eb; }
        
        /* ìƒì„¸ ì •ë³´ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .info-panel {
            position: absolute; bottom: 100px; left: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 24px; border-radius: 28px; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>

<div class="app-layout">
    <header class="h-14 flex justify-between items-center px-6 border-b bg-white shrink-0">
        <h1 class="text-xl font-black italic italic tracking-tighter">FOOTPRINTS<span class="text-blue-600">.</span></h1>
    </header>

    <main class="flex-1 relative">
        <section id="home-page" class="page p-6" style="display: block;">
            <h2 class="text-2xl font-black mb-6">ë‚˜ì˜ í™œë™</h2>
            <div id="feed-list" class="space-y-4"></div>
        </section>

        <section id="map-page" class="page" style="padding:0;">
            <div id="map"></div>
            
            <div class="info-panel">
                <div id="status-title" class="text-[10px] font-black text-blue-600 uppercase mb-3 tracking-widest text-center">Tracking Mode</div>
                <div class="flex justify-around mb-6 text-center">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Distance</p>
                        <p id="dist-val" class="text-2xl font-black">0.0km</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Time</p>
                        <p id="time-val" class="text-2xl font-black">00:00</p>
                    </div>
                    <div id="date-box" class="hidden">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Date</p>
                        <p id="date-val" class="text-xl font-black text-slate-700">--/--</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="main-action-btn" onclick="toggleTracking()" class="flex-1 h-14 bg-blue-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">íŠ¸ë˜í‚¹ ì‹œì‘</button>
                    <button id="save-btn" onclick="saveCourse()" class="w-14 h-14 bg-slate-100 rounded-2xl flex items-center justify-center">ğŸ’¾</button>
                    <button id="close-btn" onclick="exitViewMode()" class="hidden w-14 h-14 bg-slate-900 text-white rounded-2xl font-bold">âœ•</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <button onclick="go('home')" id="btn-home" class="nav-item active">EXPLORE</button>
        <button onclick="go('map')" id="btn-map" class="nav-item">TRACK</button>
    </nav>
</div>

<script>
    let map, polyline, watchId, isTracking = false, startTime, timerInterval;
    let pathData = [];
    let db = JSON.parse(localStorage.getItem('myFootprints')) || [];

    window.onload = () => { initMap(); renderFeed(); };

    function initMap() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5665, 126.9780], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        polyline = L.polyline([], { color: '#2563eb', weight: 6, lineCap: 'round' }).addTo(map);
    }

    function go(id) {
        document.getElementById('home-page').style.display = id === 'home' ? 'block' : 'none';
        document.getElementById('map-page').style.display = id === 'map' ? 'block' : 'none';
        document.getElementById('btn-home').classList.toggle('active', id === 'home');
        document.getElementById('btn-map').classList.toggle('active', id === 'map');
        if(id === 'map') setTimeout(() => map.invalidateSize(), 200);
    }

    function toggleTracking() {
        const btn = document.getElementById('main-action-btn');
        if (!isTracking) {
            isTracking = true; pathData = []; polyline.setLatLngs([]);
            startTime = Date.now();
            btn.innerText = "ì¤‘ì§€"; btn.classList.replace('bg-blue-600', 'bg-red-500');
            timerInterval = setInterval(updateTimer, 1000);
            startGPS();
        } else {
            isTracking = false;
            btn.innerText = "íŠ¸ë˜í‚¹ ì‹œì‘"; btn.classList.replace('bg-red-500', 'bg-blue-600');
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId);
        }
    }

    function updateTimer() {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const m = String(Math.floor(diff / 60)).padStart(2, '0');
        const s = String(diff % 60).padStart(2, '0');
        document.getElementById('time-val').innerText = `${m}:${s}`;
    }

    function startGPS() {
        watchId = navigator.geolocation.watchPosition(pos => {
            const loc = [pos.coords.latitude, pos.coords.longitude];
            pathData.push(loc); polyline.setLatLngs(pathData); map.panTo(loc);
            document.getElementById('dist-val').innerText = (pathData.length * 0.005).toFixed(1) + "km";
        }, null, { enableHighAccuracy: true });
    }

    function saveCourse() {
        if (pathData.length < 2) return alert("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        const title = prompt("ì½”ìŠ¤ ì´ë¦„", "ì˜¤ëŠ˜ì˜ ì‚°ì±…");
        if (!title) return;
        
        const newRecord = {
            title,
            dist: document.getElementById('dist-val').innerText,
            time: document.getElementById('time-val').innerText,
            path: pathData,
            date: new Date().toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        };
        db.unshift(newRecord);
        localStorage.setItem('myFootprints', JSON.stringify(db));
        renderFeed();
        alert("ì €ì¥ ì„±ê³µ!"); go('home');
        resetUI();
    }

    function renderFeed() {
        const container = document.getElementById('feed-list');
        container.innerHTML = db.length === 0 ? '<p class="text-center py-10 text-slate-300">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
        db.forEach((item, i) => {
            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-3xl border border-slate-100 shadow-sm active:bg-slate-50 transition";
            card.onclick = () => viewRecord(i);
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-slate-400 font-bold mb-1">${item.date}</p>
                        <p class="font-black text-lg text-slate-800">${item.title}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-600 font-black text-lg">${item.dist}</p>
                        <p class="text-[10px] font-bold text-slate-400">${item.time}</p>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // ê¸°ë¡ ìƒì„¸ë³´ê¸° ëª¨ë“œ
    function viewRecord(index) {
        const item = db[index];
        go('map');
        
        // UI ë³€ê²½ (ì¡°íšŒ ëª¨ë“œ)
        document.getElementById('status-title').innerText = "History View";
        document.getElementById('dist-val').innerText = item.dist;
        document.getElementById('time-val').innerText = item.time;
        document.getElementById('date-val').innerText = item.date.split(',')[0];
        document.getElementById('date-box').classList.remove('hidden');
        document.getElementById('main-action-btn').classList.add('hidden');
        document.getElementById('save-btn').classList.add('hidden');
        document.getElementById('close-btn').classList.remove('hidden');

        setTimeout(() => {
            polyline.setLatLngs(item.path);
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }, 300);
    }

    function exitViewMode() {
        resetUI();
        go('home');
    }

    function resetUI() {
        document.getElementById('status-title').innerText = "Tracking Mode";
        document.getElementById('dist-val').innerText = "0.0km";
        document.getElementById('time-val').innerText = "00:00";
        document.getElementById('date-box').classList.add('hidden');
        document.getElementById('main-action-btn').classList.remove('hidden');
        document.getElementById('save-btn').classList.remove('hidden');
        document.getElementById('close-btn').classList.add('hidden');
        polyline.setLatLngs([]);
    }
</script>
</body>
</html>
